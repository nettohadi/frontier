generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum VideoStatus {
  PENDING
  GENERATING_SCRIPT
  GENERATING_IMAGE_PROMPTS
  GENERATING_IMAGES
  GENERATING_AUDIO
  GENERATING_SRT
  RENDERING
  COMPLETED
  FAILED
}

enum RenderMode {
  BACKGROUND_VIDEO
  AI_IMAGES
}

enum UploadStatus {
  SCHEDULED
  UPLOADING
  COMPLETED
  FAILED
}

model Video {
  id              String       @id @default(uuid())

  // Input
  topic           String
  style           String?      @default("educational")

  // Custom topic for one-off generation (not in rotation)
  customTopicName        String?
  customTopicDescription String?      @db.Text

  // Generated content
  title           String?
  description     String?      @db.Text
  script          String?      @db.Text
  scriptWordCount Int?

  // File paths (relative to project root)
  audioPath       String?
  srtPath         String?
  outputPath      String?

  // Processing
  status          VideoStatus  @default(PENDING)
  errorMessage    String?      @db.Text
  retryCount      Int          @default(0)

  // Background video relation
  backgroundId    String?
  background      BackgroundVideo? @relation(fields: [backgroundId], references: [id])

  // Topic relation (for Hakikat/Sufi style)
  topicId         String?
  topicRelation   Topic?       @relation(fields: [topicId], references: [id])

  // Render mode selection
  renderMode      RenderMode   @default(BACKGROUND_VIDEO)

  // AI Images mode fields
  imagePrompts    Json?        // [{prompt, timing, description}]
  imagePaths      String[]     // Generated image paths

  // Overlay used (for AI Images mode)
  overlayPath     String?

  // Timestamps
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  completedAt     DateTime?

  // Job tracking
  currentJobId    String?

  // YouTube upload tracking
  uploadedToYouTube Boolean         @default(false)
  uploadSchedule    UploadSchedule?

  // Auto-upload settings
  autoUpload        Boolean         @default(false)  // Should auto-upload when complete
  uploadMode        String?         // 'immediate' | 'scheduled' | null
  uploadError       String?         @db.Text  // Error message if auto-upload failed

  @@index([status])
  @@index([createdAt])
}

model BackgroundVideo {
  id          String   @id @default(uuid())
  name        String
  filename    String   @unique
  durationMs  Int
  category    String?
  videos      Video[]

  createdAt   DateTime @default(now())

  @@index([category])
}

model Topic {
  id          String    @id @default(uuid())
  name        String    @unique
  description String    @db.Text
  isActive    Boolean   @default(true)
  usageCount  Int       @default(0)
  lastUsedAt  DateTime?

  videos      Video[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([isActive, lastUsedAt])
}

// Single table to track rotation counters for sequential asset selection
model RotationCounter {
  id          String   @id @default("singleton")
  music       Int      @default(0)
  overlay     Int      @default(0)
  colorScheme Int      @default(0)
  openingHook Int      @default(0)
  topic       Int      @default(0)
  updatedAt   DateTime @updatedAt
}

// Publer settings for YouTube upload (singleton pattern)
model PublerSettings {
  id               String   @id @default("singleton")
  apiKey           String?  @db.Text
  workspaceId      String?
  defaultChannelId String?
  autoUpload       Boolean  @default(false)
  updatedAt        DateTime @updatedAt
}

// YouTube upload scheduling
model UploadSchedule {
  id               String       @id @default(uuid())

  // Video relation
  videoId          String       @unique
  video            Video        @relation(fields: [videoId], references: [id], onDelete: Cascade)

  // YouTube details
  youtubeChannelId String
  youtubeTitle     String?
  youtubeDescription String?    @db.Text

  // Scheduling (GMT+8 timezone)
  scheduledSlot    Int          // 0-9 (10:00-19:00)
  scheduledDate    DateTime     // Date portion (midnight UTC)
  scheduledAt      DateTime     // Full datetime for upload

  // Upload tracking
  status           UploadStatus @default(SCHEDULED)
  publerJobId      String?
  youtubeUrl       String?
  errorMessage     String?      @db.Text
  progress         Int          @default(0)

  // Timestamps
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  completedAt      DateTime?

  @@unique([scheduledDate, scheduledSlot])
  @@index([status])
  @@index([scheduledDate])
}
